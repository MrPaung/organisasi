<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrgMaster Pro // Next-Gen Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        darkBg: '#0f172a',
                        darkCard: '#1e293b'
                    },
                    borderRadius: {
                        '4xl': '2rem',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.3s ease; }
        [x-cloak] { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100" 
      x-data="app()" 
      :class="darkMode ? 'dark' : ''">

    <aside class="hidden lg:flex w-72 flex-col fixed h-full z-20 bg-white dark:bg-darkCard border-r border-slate-200 dark:border-slate-700 shadow-2xl">
        <div class="p-8 flex items-center justify-between">
            <h1 class="text-2xl font-extrabold tracking-tighter text-primary">ORG<span class="text-slate-400">MASTER</span></h1>
            <button @click="darkMode = !darkMode" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 transition">
                <i class="fas" :class="darkMode ? 'fa-sun text-yellow-400' : 'fa-moon text-indigo-600'"></i>
            </button>
        </div>
        
        <nav class="flex-1 px-4 space-y-2 mt-4">
            <template x-for="m in menus">
                <button @click="menu = m.id" 
                        :class="menu === m.id ? 'bg-primary text-white shadow-lg shadow-primary/30' : 'text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800'"
                        class="w-full flex items-center p-4 rounded-2xl transition-all font-semibold group">
                    <i class="fas w-8 group-hover:scale-110 transition" :class="m.icon"></i>
                    <span x-text="m.label"></span>
                </button>
            </template>
        </nav>

        <div class="p-6">
            <button @click="exportToExcel" class="w-full bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white py-4 rounded-2xl font-bold hover:scale-105 transition-transform">
                <i class="fas fa-file-excel mr-2"></i> Export Data
            </button>
        </div>
    </aside>

    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-darkCard/90 backdrop-blur-xl border-t border-slate-200 dark:border-slate-700 z-50 px-4 py-3 flex justify-between items-center shadow-2xl">
        <template x-for="m in menus">
            <button @click="menu = m.id" :class="menu === m.id ? 'text-primary scale-110' : 'text-slate-400'">
                <i class="fas text-xl" :class="m.icon"></i>
            </button>
        </template>
        <button @click="darkMode = !darkMode" class="text-slate-400">
            <i class="fas text-xl" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
        </button>
    </nav>

    <main class="flex-1 lg:ml-72 p-6 lg:p-12 mb-24 lg:mb-0">
        
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div>
                <h2 class="text-3xl font-extrabold" x-text="getCurrentMenuLabel()"></h2>
                <p class="text-slate-400 dark:text-slate-500 font-medium">Manajemen Organisasi v2.0</p>
            </div>
            <div x-show="menu === 'data'" class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" x-model="search" placeholder="Cari Nama/ID..." 
                       class="pl-12 pr-6 py-3 bg-white dark:bg-darkCard rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-primary w-full md:w-80">
            </div>
        </header>

        <div x-show="menu === 'tambah'" x-cloak x-transition class="max-w-4xl mx-auto">
            <div class="bg-white dark:bg-darkCard rounded-4xl p-8 shadow-xl border border-slate-100 dark:border-slate-800">
                <form @submit.prevent="simpanData" class="space-y-8">
                    <div class="bg-primary/10 dark:bg-primary/5 p-6 rounded-3xl border border-primary/20 flex items-center justify-between">
                        <div>
                            <span class="text-[10px] font-bold text-primary uppercase tracking-widest">Preview ID Anggota</span>
                            <h3 class="text-3xl font-mono font-bold text-primary" x-text="generateID()"></h3>
                        </div>
                        <i class="fas fa-id-card text-4xl text-primary/30"></i>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <label class="text-sm font-bold opacity-50 uppercase tracking-widest ml-2 italic">Foto Profil</label>
                            <div class="relative h-64 bg-slate-50 dark:bg-slate-800/50 rounded-4xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex items-center justify-center overflow-hidden group">
                                <template x-if="form.foto">
                                    <img :src="form.foto" class="w-full h-full object-cover">
                                </template>
                                <div x-show="!form.foto" class="text-center">
                                    <i class="fas fa-image text-4xl text-slate-300 mb-2"></i>
                                    <p class="text-[10px] font-bold text-slate-400">TAP UNTUK UPLOAD</p>
                                </div>
                                <input type="file" @change="handleFileUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="text-[10px] font-bold ml-2 italic">THN</label>
                                    <input type="text" x-model="form.thn" placeholder="24" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold ml-2 italic">RT</label>
                                    <input type="text" x-model="form.rt" placeholder="02" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold ml-2 italic">NO</label>
                                    <input type="text" x-model="form.urut" placeholder="001" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                            <input type="text" x-model="form.nama" placeholder="NAMA LENGKAP" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-primary">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold ml-2 italic">TGL LAHIR</label>
                                    <input type="date" x-model="form.tglLahir" @input="hitungUsia()" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold ml-2 italic">TGL BERGABUNG</label>
                                    <input type="date" x-model="form.tglGabung" @input="hitungDurasi()" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                                </div>
                            </div>
                            <input type="text" x-model="form.pekerjaan" placeholder="PEKERJAAN" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                            <input type="text" x-model="form.noHp" placeholder="NO TELEPON/WA" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                        </div>
                    </div>

                    <button type="submit" :disabled="loading" class="w-full bg-primary text-white py-5 rounded-3xl font-bold shadow-xl shadow-primary/20 hover:scale-[1.01] transition-all flex items-center justify-center gap-3">
                        <i x-show="loading" class="fas fa-spinner animate-spin"></i>
                        <span x-text="loading ? 'Sinkronisasi Cloud...' : 'Daftarkan Sekarang'"></span>
                    </button>
                </form>
            </div>
        </div>

        <div x-show="menu === 'data'" x-cloak x-transition>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <template x-for="item in filteredData()" :key="item.idAnggota">
                    <div class="bg-white dark:bg-darkCard p-6 rounded-4xl border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-2xl transition-all group">
                        <div class="flex items-center gap-4 mb-6">
                            <img :src="item.foto || 'https://via.placeholder.com/150'" class="w-20 h-20 rounded-3xl object-cover shadow-lg border-2 border-white dark:border-slate-700">
                            <div>
                                <h4 class="text-xl font-extrabold" x-text="item.nama"></h4>
                                <span class="text-xs font-mono font-bold text-primary px-3 py-1 bg-primary/10 rounded-full" x-text="item.idAnggota"></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Usia</p>
                                <p class="font-bold text-slate-700 dark:text-slate-300" x-text="item.usia + ' Thn'"></p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">RT</p>
                                <p class="font-bold text-slate-700 dark:text-slate-300" x-text="item.rt"></p>
                            </div>
                        </div>
                        <div class="p-4 bg-primary/5 border border-primary/10 rounded-2xl mb-4">
                            <p class="text-[9px] font-bold text-primary uppercase tracking-widest">Lama Bergabung</p>
                            <p class="font-bold text-xs" x-text="item.durasi"></p>
                        </div>
                        <button @click="hapusData(item.idAnggota)" class="w-full text-[10px] font-bold text-red-400 hover:text-red-500 transition uppercase tracking-widest">Hapus Anggota</button>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="menu === 'agenda'" x-cloak x-transition class="max-w-5xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-white dark:bg-darkCard p-8 rounded-4xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <h3 class="text-xl font-bold mb-6">Buat Agenda Baru</h3>
                    <form @submit.prevent="tambahAgenda" class="space-y-4">
                        <input type="text" x-model="agendaForm.nama" placeholder="Nama Acara" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                        <input type="text" x-model="agendaForm.lokasi" placeholder="Tempat/Lokasi" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                        <input type="date" x-model="agendaForm.tanggal" class="w-full bg-slate-50 dark:bg-slate-800 border-none p-4 rounded-2xl">
                        <button class="w-full bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white py-4 rounded-2xl font-bold italic">Terbitkan Agenda</button>
                    </form>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <template x-for="a in agenda" :key="a.id">
                        <div class="bg-white dark:bg-darkCard p-8 rounded-4xl border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h4 class="text-2xl font-bold" x-text="a.nama"></h4>
                                    <p class="text-slate-400 text-sm italic"><i class="fas fa-map-marker-alt mr-2"></i><span x-text="a.lokasi"></span> | <span x-text="a.tanggal"></span></p>
                                </div>
                                <button @click="hapusAgenda(a.id)" class="text-slate-300 hover:text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                            <hr class="border-slate-100 dark:border-slate-800 mb-6">
                            <h5 class="text-sm font-bold mb-4 uppercase tracking-widest text-primary italic">Daftar Hadir Absensi</h5>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="agt in dataAnggota" :key="agt.idAnggota">
                                    <button @click="toggleAbsen(a.id, agt.idAnggota)" 
                                            :class="isHadir(a.id, agt.idAnggota) ? 'bg-primary text-white' : 'bg-slate-50 dark:bg-slate-800 text-slate-400'"
                                            class="px-4 py-2 rounded-xl text-[10px] font-bold transition-all">
                                        <i class="fas mr-2" :class="isHadir(a.id, agt.idAnggota) ? 'fa-check' : 'fa-plus'"></i>
                                        <span x-text="agt.nama"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="menu === 'struktur'" x-cloak x-transition>
            <div class="bg-white dark:bg-darkCard p-12 rounded-[3rem] border border-slate-100 dark:border-slate-800 flex flex-col items-center">
                <h3 class="text-3xl font-extrabold mb-12 gradient-text">Struktur Kepengurusan</h3>
                
                <div class="flex flex-col items-center gap-12">
                    <div class="relative group">
                        <div class="w-40 h-40 bg-primary rounded-4xl flex flex-col items-center justify-center text-white shadow-2xl relative z-10">
                            <i class="fas fa-user-tie text-3xl mb-2"></i>
                            <p class="text-[10px] font-bold opacity-70">Ketua Umum</p>
                            <p class="font-extrabold">Fulan Ahmad</p>
                        </div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 w-1 h-24 bg-slate-200 dark:bg-slate-800"></div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-8 md:gap-24 relative">
                        <div class="w-32 h-32 bg-white dark:bg-slate-800 border-2 border-primary rounded-3xl flex flex-col items-center justify-center">
                            <p class="text-[8px] font-bold text-primary">Wakil Ketua</p>
                            <p class="font-bold text-xs italic">Budi Santoso</p>
                        </div>
                        <div class="w-32 h-32 bg-white dark:bg-slate-800 border-2 border-primary rounded-3xl flex flex-col items-center justify-center">
                            <p class="text-[8px] font-bold text-primary">Sekretaris</p>
                            <p class="font-bold text-xs italic">Siti Aminah</p>
                        </div>
                        <div class="w-32 h-32 bg-white dark:bg-slate-800 border-2 border-primary rounded-3xl flex flex-col items-center justify-center">
                            <p class="text-[8px] font-bold text-primary">Bendahara</p>
                            <p class="font-bold text-xs italic">Diana Putri</p>
                        </div>
                    </div>
                </div>
                
                <p class="mt-20 text-slate-400 text-xs text-center italic">Grafik struktur organisasi otomatis diperbarui berdasarkan SK Pengurus.</p>
            </div>
        </div>

    </main>

    <script>
        // MASUKKAN URL GOOGLE APPS SCRIPT ANDA DISINI
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8bOvuBz5ZGznLWyvyMJrhbrFqoDNP7zVe4pC-TeHimDurlR9--1bylNVth2AakXE/exec';

        function app() {
            return {
                menu: 'dashboard',
                darkMode: localStorage.getItem('dark') === 'true',
                loading: false,
                search: '',
                dataAnggota: JSON.parse(localStorage.getItem('db_pro')) || [],
                agenda: JSON.parse(localStorage.getItem('db_agenda')) || [],
                absensi: JSON.parse(localStorage.getItem('db_absen')) || {}, // { agendaId: [memberId1, memberId2] }
                
                menus: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-pie' },
                    { id: 'tambah', label: 'Tambah Anggota', icon: 'fa-user-plus' },
                    { id: 'data', label: 'Data Anggota', icon: 'fa-address-book' },
                    { id: 'agenda', label: 'Agenda & Absen', icon: 'fa-calendar-check' },
                    { id: 'struktur', label: 'Struktur Organisasi', icon: 'fa-sitemap' },
                ],

                form: { thn: '', rt: '', urut: '', nama: '', tglLahir: '', usia: '', tglGabung: '', durasi: '', pekerjaan: '', noHp: '', foto: '' },
                agendaForm: { nama: '', lokasi: '', tanggal: '' },

                init() {
                    this.$watch('darkMode', val => localStorage.setItem('dark', val));
                },

                getCurrentMenuLabel() {
                    return this.menus.find(m => m.id === this.menu).label;
                },

                handleFileUpload(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (f) => { this.form.foto = f.target.result; };
                    reader.readAsDataURL(file);
                },

                generateID() {
                    return (this.form.thn || '00') + (this.form.rt || '00') + (this.form.urut || '000');
                },

                hitungUsia() {
                    if(!this.form.tglLahir) return;
                    const birth = new Date(this.form.tglLahir);
                    this.form.usia = new Date().getFullYear() - birth.getFullYear();
                },

                hitungDurasi() {
                    if(!this.form.tglGabung) return;
                    const start = new Date(this.form.tglGabung);
                    const now = new Date();
                    let years = now.getFullYear() - start.getFullYear();
                    let months = now.getMonth() - start.getMonth();
                    let days = now.getDate() - start.getDate();
                    if (days < 0) { months--; days += 30; }
                    if (months < 0) { years--; months += 12; }
                    this.form.durasi = `${years} Thn, ${months} Bln, ${days} Hari`;
                },

                async simpanData() {
                    this.loading = true;
                    const payload = { idAnggota: this.generateID(), ...this.form };
                    this.dataAnggota.push(payload);
                    localStorage.setItem('db_pro', JSON.stringify(this.dataAnggota));
                    
                    try {
                        await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify(payload)
                        });
                        alert('Data Berhasil Terkirim ke Cloud! ðŸš€');
                    } catch (e) {
                        alert('Tersimpan Lokal (Cloud Sedang Sibuk)');
                    }
                    
                    this.form = { thn: '', rt: '', urut: '', nama: '', tglLahir: '', usia: '', tglGabung: '', durasi: '', pekerjaan: '', noHp: '', foto: '' };
                    this.loading = false;
                    this.menu = 'data';
                },

                filteredData() {
                    return this.dataAnggota.filter(i => 
                        i.nama.toLowerCase().includes(this.search.toLowerCase()) || 
                        i.idAnggota.includes(this.search)
                    );
                },

                hapusData(id) {
                    if(confirm('Hapus anggota ini?')) {
                        this.dataAnggota = this.dataAnggota.filter(i => i.idAnggota !== id);
                        localStorage.setItem('db_pro', JSON.stringify(this.dataAnggota));
                    }
                },

                // Agenda & Absensi Logic
                tambahAgenda() {
                    const newAgenda = { id: Date.now(), ...this.agendaForm };
                    this.agenda.push(newAgenda);
                    localStorage.setItem('db_agenda', JSON.stringify(this.agenda));
                    this.agendaForm = { nama: '', lokasi: '', tanggal: '' };
                },

                hapusAgenda(id) {
                    this.agenda = this.agenda.filter(a => a.id !== id);
                    localStorage.setItem('db_agenda', JSON.stringify(this.agenda));
                },

                toggleAbsen(agendaId, memberId) {
                    if(!this.absensi[agendaId]) this.absensi[agendaId] = [];
                    const idx = this.absensi[agendaId].indexOf(memberId);
                    if(idx === -1) this.absensi[agendaId].push(memberId);
                    else this.absensi[agendaId].splice(idx, 1);
                    localStorage.setItem('db_absen', JSON.stringify(this.absensi));
                },

                isHadir(agendaId, memberId) {
                    return this.absensi[agendaId] && this.absensi[agendaId].includes(memberId);
                },

                exportToExcel() {
                    const cleanData = this.dataAnggota.map(({foto, ...rest}) => rest);
                    const ws = XLSX.utils.json_to_sheet(cleanData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Anggota");
                    XLSX.writeFile(wb, "Data_Organisasi_Full.xlsx");
                }
            }
        }
    </script>
</body>
</html>
